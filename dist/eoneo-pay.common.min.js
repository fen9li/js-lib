"use strict";var CARD_TYPES=[{name:"visaelectron",patterns:/^(4026|417500|4405|4508|4844|4913|4917)/,format:/(\d{1,4})/g,length:/^16$/,cvcLength:/^3$/,luhn:!0},{name:"maestro",patterns:/^(5018|502|503|56|58|639|6220|67)/,format:/(\d{1,4})/g,length:/^(12|13|14|15|16|17|18|19)/,cvcLength:/^3$/,luhn:!0},{name:"forbrugsforeningen",patterns:/^600/,format:/(\d{1,4})/g,length:/^16$/,cvcLength:/^3$/,luhn:!0},{name:"dankort",patterns:/^5019/,format:/(\d{1,4})/g,length:/^16$/,cvcLength:/^3$/,luhn:!0},{name:"visa",patterns:/^4/,format:/(\d{1,4})/g,length:/^(13|16)/,cvcLength:/^3$/,luhn:!0},{name:"mastercard",patterns:/^(51|52|53|54|55|22|23|24|25|26|27)/,format:/(\d{1,4})/g,length:/^(13|16)/,cvcLength:/^3$/,luhn:!0},{name:"amex",patterns:/^(34|37)/,format:/(\d{1,4})(\d{1,6})?(\d{1,5})?/,length:/^15$/,cvcLength:/^(3|4)/,luhn:!0},{name:"dinersclub",patterns:/^(30|36|38|39)/,format:/(\d{1,4})(\d{1,6})?(\d{1,4})?/,length:/^14$/,cvcLength:/^3$/,luhn:!0},{name:"discover",patterns:/^(60|64|65|622)/,format:/(\d{1,4})/g,length:/^16$/,cvcLength:/^3$/,luhn:!0},{name:"unionpay",patterns:/^(62|88)/,format:/(\d{1,4})/g,length:/^(16|17|18|19)/,cvcLength:/^3$/,luhn:!1},{name:"jcb",patterns:/^35/,format:/(\d{1,4})/g,length:/^16$/,cvcLength:/^3$/,luhn:!0}],msg={invalidCardNumber:"invalid card number",invalidCardName:"invalid card name",invalidAccountName:"invalid account name",invalidAccountNumber:"invalid account number",expiryRequired:"expiry.month and expiry.year is required",accountPrefixRequired:"account prefix is required",expiryMonthLength:"expiry month has to consist of 2 symbols",expiryYearLength:"expiry year has to consist of 4 symbols",tokenRequired:"token is required",unauthorized:"user is not authorized",requestError:"unsuccessful request"};function createError(e){return{name:"eoneo-exception",message:e}}function emitError(e,t){var n=e;n instanceof Array&&(n=n.join(", "));var r=createError(n);if("function"!=typeof t)return Promise?Promise.reject(r):r;t(r)}var EoneoPay=function(){function e(e){if(this.params=e,!e||"object"==typeof e&&!e.token)throw new Error("token is required")}return Object.defineProperty(e.prototype,"token",{get:function(){var e=this.params;return"string"==typeof e?e:e.token},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"url",{get:function(){var e=this.params;return"object"==typeof e&&e.url?e.url:"https://pay.eoneopay.com"},enumerable:!0,configurable:!0}),e.prototype.getCardTypeByNumber=function(e){return void 0===e&&(e=""),CARD_TYPES.find(function(t){return t.patterns.test(e)})},e.prototype.luhnCheck=function(e){for(var t,n=[0,2,4,6,8,1,3,5,7,9],r=e.length,o=1,a=0;r;)t=parseInt(e.charAt(--r),10),a+=(o^=1)?n[t]:t;return!!a&&a%10==0},e.prototype.sendRequest=function(e){var t;if(XMLHttpRequest)t=new XMLHttpRequest;else try{t=new ActiveXObject("MSXML2.XMLHTTP.3.0")}catch(e){throw new Error("current platform does not support XMLHttpRequest")}var n=e.callback,r=this.url+e.endpoint;t.responseType="json",t.open(e.type,r,!0),t.setRequestHeader("Authorization","Basic "+btoa(this.token+":")),t.setRequestHeader("Content-type","application/vnd.eoneopay.v1+json"),t.setRequestHeader("Accept","application/json");var o=function(e,t){var r=createError(e);"function"==typeof n?n(r):"function"==typeof t&&t(r)},a=e.data?JSON.stringify(e.data):null,i=function(e,r){t.onerror=function(){o(msg.requestError,r)},t.onload=function(){var a=String(t.status),i=t.response||{};/^2/.test(a)?("function"==typeof n&&n(null,t.response),"function"==typeof e&&e(t.response)):/401/.test(a)?o(msg.unauthorized,r):o(i.message||t.statusText,r)},t.send(a)};if(Promise&&!n)return new Promise(i);i()},e.prototype.getCardTypeByName=function(e){return void 0===e&&(e=""),CARD_TYPES.find(function(t){return t.name===e})},e.prototype.getPaymentSystem=function(e){var t=this.getCardTypeByNumber(String(e));return t?t.name:""},e.prototype.getCardNameBasedOnNumber=function(e){return this.getPaymentSystem(e)},e.prototype.validateAccountNumber=function(e){return/^[0-9]{6,9}$/.test(String(e))},e.prototype.validateAccountName=function(e){return/^.{6,100}$/.test(e)},e.prototype.validateCardNumber=function(e){var t=String(e),n=this.getCardTypeByNumber(t);if(!n)return!1;var r=n.length.test(String(t.length)),o=this.luhnCheck(t);return r&&o},e.prototype.tokeniseCard=function(e,t){return this.tokenizeCard(e,t)},e.prototype.tokenizeCard=function(e,t){var n=[];return this.validateCardNumber(e.number)||n.push(msg.invalidCardNumber),this.validateAccountName(e.name)||n.push(msg.invalidCardName),e.expiry?2!==e.expiry.month.length?n.push(msg.expiryMonthLength):/^(.{2}|.{4})$/.test(e.expiry.year)||n.push(msg.expiryYearLength):n.push(msg.expiryRequired),n.length?emitError(n,t):(e.type="credit_card",this.sendRequest({type:"POST",endpoint:"/tokens",data:e,callback:t}))},e.prototype.tokeniseAccount=function(e,t){return this.tokenizeAccount(e,t)},e.prototype.tokenizeAccount=function(e,t){var n=[];return this.validateAccountNumber(e.number)||n.push(msg.invalidAccountNumber),this.validateAccountName(e.name)||n.push(msg.invalidAccountName),e.prefix||n.push(msg.accountPrefixRequired),n.length?emitError(n,t):(e.country="AU",e.type="bank_account",this.sendRequest({type:"POST",endpoint:"/tokens",data:e,callback:t}))},e.prototype.getTokenInfo=function(e,t){return e?this.sendRequest({type:"GET",endpoint:"/tokens/"+e,callback:t}):emitError(msg.tokenRequired,t)},e}();module.exports=EoneoPay;
